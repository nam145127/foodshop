<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“© TÆ° váº¥n khÃ¡ch hÃ ng | Viper</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    #chatBox { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; background: #fff; margin-bottom: 10px; border-radius: 6px; }
    #chatBox p.bot { color: #007bff; margin: 5px 0; }
    #chatBox p.user { color: #28a745; text-align: right; margin: 5px 0; }
    #chatForm { display: flex; gap: 10px; }
    #chatInput { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    #chatForm button { padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ğŸ’¬ Trá»£ lÃ½ tÆ° váº¥n Viper</h1>

  <div id="chatBox"></div>

  <form id="chatForm">
    <input type="text" id="chatInput" placeholder="Nháº­p cÃ¢u tráº£ lá»i..." required />
    <button type="submit">Gá»­i</button>
  </form>

  <script>
    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");

    const steps = [
      { key: "name", question: "ğŸ‘‹ Xin chÃ o! TÃªn báº¡n lÃ  gÃ¬?" },
      { key: "phone", question: "ğŸ“ Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n lÃ  gÃ¬?" },
      { key: "email", question: "ğŸ“§ Báº¡n cÃ³ thá»ƒ cho mÃ¬nh email Ä‘á»ƒ liÃªn há»‡ khÃ´ng? (bá» qua náº¿u khÃ´ng cÃ³)" },
      { key: "subject", question: "ğŸ“ Báº¡n cáº§n tÆ° váº¥n vá» mÃ³n nÃ o hoáº·c váº¥n Ä‘á» gÃ¬?" },
      { key: "message", question: "ğŸ’¬ Báº¡n cÃ³ thá»ƒ nÃ³i rÃµ yÃªu cáº§u hoáº·c cÃ¢u há»i cá»¥ thá»ƒ hÆ¡n khÃ´ng?" }
    ];

    let currentStep = 0;
    let collectedData = {};

    function addMessage(text, sender = "bot") {
      const p = document.createElement("p");
      p.textContent = text;
      p.className = sender;
      chatBox.appendChild(p);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function askNextQuestion() {
      if (currentStep < steps.length) {
        addMessage(steps[currentStep].question, "bot");
      } else {
        sendToServer();
      }
    }

    async function sendToServer() {
      try {
        const token = localStorage.getItem("token");
        const res = await fetch("http://localhost:3000/api/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token && { Authorization: "Bearer " + token })
          },
          body: JSON.stringify(collectedData)
        });

        const data = await res.json();
        if (res.ok) {
          addMessage("âœ… Cáº£m Æ¡n báº¡n! YÃªu cáº§u cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c gá»­i. ChÃºng tÃ´i sáº½ pháº£n há»“i sá»›m!", "bot");
          chatForm.style.display = "none";
        } else {
          throw new Error(data.error || "Lá»—i khi gá»­i");
        }
      } catch (err) {
        addMessage("âŒ ÄÃ£ cÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i sau.", "bot");
      }
    }

    chatForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const answer = chatInput.value.trim();
      if (!answer) return;

      addMessage(answer, "user");
      collectedData[steps[currentStep].key] = answer;
      chatInput.value = "";
      currentStep++;
      setTimeout(askNextQuestion, 500);
    });

    askNextQuestion();
  </script>
</body>
</html>
